<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">

<div th:fragment="content">
    <section class="view-section active flex-col justify-center items-center min-h-screen w-full relative overflow-auto">
        <!-- Background Decor -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
            <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
            <div class="absolute top-1/3 right-1/4 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
        </div>

        <div class="w-full max-w-4xl px-4 py-4">
            <!-- Header -->
            <div class="text-center mb-4">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-600/20 text-blue-400 mb-2">
                    <i class="fa-solid fa-robot text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-tight text-white" th:text="#{setup.title}">Interview Setup</h1>
                <p class="text-slate-400 mt-1 text-sm" th:text="#{setup.subtitle}">Configure your interview session</p>
            </div>

            <!-- Progress Steps -->
            <th:block th:replace="~{pages/setup/fragments/progress :: progressIndicator(currentStep=${currentStep})}"/>

            <!-- Form Container -->
            <div class="bg-slate-800/80 p-6 rounded-2xl shadow-2xl border border-slate-700 backdrop-blur-md">
                <form th:action="@{/setup/step2}" th:object="${setupForm}" method="post" enctype="multipart/form-data">
                    <!-- Step Title -->
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-bold text-white mb-1" th:text="#{setup.step2.title}">Interview Details</h2>
                        <p class="text-slate-400 text-sm" th:text="#{setup.step2.subtitle}">Choose your target position and settings</p>
                    </div>

                    <div class="space-y-4">
                        <!-- Target Position -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-3" for="job-position">
                                <span th:text="#{setup.step2.targetPosition}">Target Position</span>
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <select id="job-position"
                                        name="position"
                                        th:classappend="${#fields.hasErrors('position')} ? 'border-red-500' : ''"
                                        class="w-full bg-slate-900 border-2 border-slate-700 rounded-xl px-5 py-4 text-white appearance-none focus:outline-none focus:border-blue-500 transition"
                                        onchange="toggleCustomPosition(this)"
                                        required>
                                    <option value="" th:selected="${setupForm.position == null or setupForm.position == ''}" th:text="#{setup.step2.targetPosition.placeholder}">Select a position...</option>
                                    <option value="Junior Java Developer" th:selected="${setupForm.position == 'Junior Java Developer'}" th:text="#{setup.position.juniorJava}">Junior Java Developer</option>
                                    <option value="Senior Java Developer" th:selected="${setupForm.position == 'Senior Java Developer'}" th:text="#{setup.position.seniorJava}">Senior Java Developer</option>
                                    <option value="Frontend Developer" th:selected="${setupForm.position == 'Frontend Developer'}" th:text="#{setup.position.frontend}">Frontend Developer</option>
                                    <option value="Full Stack Developer" th:selected="${setupForm.position == 'Full Stack Developer'}" th:text="#{setup.position.fullstack}">Full Stack Developer</option>
                                    <option value="QA Engineer" th:selected="${setupForm.position == 'QA Engineer'}" th:text="#{setup.position.qa}">QA Engineer</option>
                                    <option value="DevOps Engineer" th:selected="${setupForm.position == 'DevOps Engineer'}" th:text="#{setup.position.devops}">DevOps Engineer</option>
                                    <option value="Project Manager" th:selected="${setupForm.position == 'Project Manager'}" th:text="#{setup.position.projectManager}">Project Manager</option>
                                    <option value="Product Manager" th:selected="${setupForm.position == 'Product Manager'}" th:text="#{setup.position.productManager}">Product Manager</option>
                                    <option value="Data Scientist" th:selected="${setupForm.position == 'Data Scientist'}" th:text="#{setup.position.dataScientist}">Data Scientist</option>
                                    <option value="custom" th:selected="${setupForm.position == 'custom'}" th:text="#{setup.position.custom}">Other (Custom)</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-5 top-5 text-slate-500 pointer-events-none"></i>
                            </div>
                            <p th:if="${#fields.hasErrors('position')}" th:errors="*{position}" class="mt-2 text-sm text-red-400"></p>

                            <!-- Custom Position Input -->
                            <div id="custom-position-container" 
                                 th:classappend="${setupForm.position != 'custom'} ? 'hidden' : ''"
                                 class="mt-3">
                                <label for="custom-position" class="sr-only">Custom Position</label>
                                <input type="text"
                                       id="custom-position"
                                       th:field="*{customPosition}"
                                       th:placeholder="#{setup.step2.customPosition.placeholder}"
                                       th:classappend="${#fields.hasErrors('customPosition')} ? 'border-red-500 focus:border-red-500' : ''"
                                       class="w-full bg-slate-900 border-2 border-slate-700 rounded-xl px-5 py-4 text-white focus:outline-none focus:border-blue-500 transition"
                                       maxlength="50"
                                       autocomplete="off">
                                <p class="mt-1 text-xs text-slate-500">Letters, numbers, and basic punctuation (max 50 characters)</p>
                                <p th:if="${#fields.hasErrors('customPosition')}" th:errors="*{customPosition}" class="mt-2 text-sm text-red-400 flex items-center gap-1">
                                    <i class="fa-solid fa-circle-exclamation"></i>
                                </p>
                            </div>
                        </div>

                        <!-- Difficulty Level -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-3">
                                <span th:text="#{setup.difficulty.label}">Difficulty Level</span>
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="grid grid-cols-3 gap-3">
                                <!-- Easy -->
                                <label class="cursor-pointer group relative">
                                    <input type="radio" th:field="*{difficulty}" value="Easy" class="peer sr-only">
                                    <div class="text-center py-4 rounded-xl border-2 border-slate-700 bg-slate-900 text-slate-400 peer-checked:bg-green-500/10 peer-checked:border-green-500 peer-checked:text-green-400 transition hover:bg-slate-800 font-medium">
                                        <i class="fa-solid fa-mug-hot text-xl mb-2"></i>
                                        <div th:text="#{setup.difficulty.easy}">Chill</div>
                                    </div>
                                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-700 text-xs text-slate-200 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10" th:text="#{setup.difficulty.easy.tooltip}">
                                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-700"></div>
                                    </div>
                                </label>
                                <!-- Standard -->
                                <label class="cursor-pointer group relative">
                                    <input type="radio" th:field="*{difficulty}" value="Standard" class="peer sr-only">
                                    <div class="text-center py-4 rounded-xl border-2 border-slate-700 bg-slate-900 text-slate-400 peer-checked:bg-blue-500/10 peer-checked:border-blue-500 peer-checked:text-blue-400 transition hover:bg-slate-800 font-medium">
                                        <i class="fa-solid fa-briefcase text-xl mb-2"></i>
                                        <div th:text="#{setup.difficulty.standard}">Standard</div>
                                    </div>
                                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-700 text-xs text-slate-200 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10" th:text="#{setup.difficulty.standard.tooltip}">
                                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-700"></div>
                                    </div>
                                </label>
                                <!-- Hard -->
                                <label class="cursor-pointer group relative">
                                    <input type="radio" th:field="*{difficulty}" value="Hard" class="peer sr-only">
                                    <div class="text-center py-4 rounded-xl border-2 border-slate-700 bg-slate-900 text-slate-400 peer-checked:bg-red-500/10 peer-checked:border-red-500 peer-checked:text-red-400 transition hover:bg-slate-800 font-medium">
                                        <i class="fa-solid fa-fire text-xl mb-2"></i>
                                        <div th:text="#{setup.difficulty.hard}">Stress</div>
                                    </div>
                                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-700 text-xs text-slate-200 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10" th:text="#{setup.difficulty.hard.tooltip}">
                                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-700"></div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- CV Upload -->
                        <div id="cv-upload-section">
                            <label class="block text-sm font-medium text-slate-300 mb-3">
                                <span th:text="#{setup.cv.label}">Resume/CV</span>
                                <span class="text-slate-500" th:text="#{setup.cv.optional}">(Optional)</span>
                            </label>

                            <!-- Show uploaded file if exists (server-side) -->
                            <div th:if="${setupForm.cvFileName != null}" id="cv-preview-server" class="mb-3 p-4 bg-slate-900/50 border-2 border-green-500/50 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-file-lines text-2xl text-green-400"></i>
                                    <div class="flex-1">
                                        <p class="text-green-400 font-medium" th:text="${setupForm.cvFileName}">cv.pdf</p>
                                        <p class="text-xs text-slate-500" th:text="#{setup.cv.uploaded}">File uploaded</p>
                                    </div>
                                    <a th:href="@{/setup/step2(clearCv=true)}" class="text-red-400 hover:text-red-300 text-sm font-medium" th:text="#{setup.cv.remove}">Remove</a>
                                </div>
                            </div>

                            <!-- Client-side preview (shown immediately after file selection) -->
                            <div id="cv-preview-client" class="hidden mb-3 p-4 bg-slate-900/50 border-2 border-blue-500/50 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-file-lines text-2xl text-blue-400"></i>
                                    <div class="flex-1">
                                        <p id="cv-preview-filename" class="text-blue-400 font-medium">file.pdf</p>
                                        <p class="text-xs text-slate-500" th:text="#{setup.cv.processing}">Processing...</p>
                                    </div>
                                    <div class="animate-spin">
                                        <i class="fa-solid fa-spinner text-blue-400"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload area (show only if no file uploaded) -->
                            <div th:if="${setupForm.cvFileName == null}" id="cv-upload-area" class="relative border-2 border-dashed border-slate-700 rounded-xl p-8 text-center hover:border-blue-500 transition cursor-pointer bg-slate-900/50">
                                <label for="cv-file-input" class="sr-only">Upload CV File</label>
                                <input type="file"
                                       id="cv-file-input"
                                       name="cvFile"
                                       accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                                       class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                       onchange="handleCvFileSelect(this)">
                                <div>
                                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-500 mb-3"></i>
                                    <p class="text-slate-400 font-medium" th:text="#{setup.cv.dropText}">Drop your CV here or click to browse</p>
                                    <p class="text-slate-600 text-xs mt-2" th:text="#{setup.cv.fileTypes}">PDF or DOCX, max 2MB</p>
                                </div>
                            </div>

                            <!-- Client-side error display (for JS validation) -->
                            <div id="cv-error-client" class="hidden mt-2 p-3 bg-red-500/10 border border-red-500/50 rounded-lg">
                                <p id="cv-error-message" class="text-sm text-red-400 flex items-center gap-2">
                                    <i class="fa-solid fa-circle-exclamation"></i>
                                    <span></span>
                                </p>
                            </div>

                            <!-- Server-side error display -->
                            <p th:if="${#fields.hasErrors('cvFile')}" th:errors="*{cvFile}" class="mt-2 text-sm text-red-400 flex items-center gap-1">
                                <i class="fa-solid fa-circle-exclamation"></i>
                            </p>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex items-center justify-between mt-6 pt-4 border-t border-slate-700">
                        <a th:href="@{/setup/step1}"
                           class="px-6 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
                            <i class="fa-solid fa-arrow-left mr-2"></i>
                            <span th:text="#{setup.button.back}">Back</span>
                        </a>
                        <button type="submit"
                                class="px-8 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold transition shadow-lg shadow-blue-500/30">
                            <span th:text="#{setup.button.next}">Next</span>
                            <i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <script th:inline="javascript">
        function toggleCustomPosition(select) {
            const container = document.getElementById('custom-position-container');
            if (select.value === 'custom') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function showCvError(message) {
            const errorContainer = document.getElementById('cv-error-client');
            const errorMessage = document.getElementById('cv-error-message');
            if (errorContainer && errorMessage) {
                errorMessage.textContent = message;
                errorContainer.classList.remove('hidden');
            }
        }

        function hideCvError() {
            const errorContainer = document.getElementById('cv-error-client');
            if (errorContainer) {
                errorContainer.classList.add('hidden');
            }
        }

        function handleCvFileSelect(input) {
            hideCvError();
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                
                // Validate file type
                const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                const validExtensions = ['.pdf', '.docx'];
                const ext = fileName.toLowerCase().substring(fileName.lastIndexOf('.'));
                
                if (!validTypes.includes(file.type) && !validExtensions.includes(ext)) {
                    showCvError(/*[[#{validation.cv.invalidType}]]*/ 'Please upload a PDF or DOCX file');
                    input.value = '';
                    return;
                }
                
                // Validate file size (2MB max)
                if (file.size > 2 * 1024 * 1024) {
                    showCvError(/*[[#{validation.cv.tooLarge}]]*/ 'File size must be less than 2MB');
                    input.value = '';
                    return;
                }
                
                // Show client-side preview immediately
                const uploadArea = document.getElementById('cv-upload-area');
                const clientPreview = document.getElementById('cv-preview-client');
                const filenameEl = document.getElementById('cv-preview-filename');
                
                if (uploadArea) uploadArea.classList.add('hidden');
                if (clientPreview) clientPreview.classList.remove('hidden');
                if (filenameEl) filenameEl.textContent = fileName;
                
                // Auto-submit the form to process the CV on the server
                const form = input.closest('form');
                if (form) {
                    setTimeout(() => form.submit(), 100);
                }
            }
        }
    </script>
</div>

</html>
