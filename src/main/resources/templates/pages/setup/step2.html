<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">

<div th:fragment="content">
	<section class="view-section active flex-col justify-center items-center min-h-screen w-full relative overflow-auto">
		<!--/*  Background Decor  */-->
		<div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
			<div class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
			<div class="absolute top-1/3 right-1/4 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
		</div>

		<div class="w-full max-w-4xl px-4 py-2 tall:py-4">
			<!--/*  Header  */-->
			<div class="text-center mb-2 tall:mb-3">
				<div class="inline-flex items-center justify-center mb-1">
					<img th:src="@{/media/logo.png}" alt="Logo" class="h-10 tall:h-14 w-auto">
				</div>
				<h1 class="text-2xl font-bold tracking-tight text-white" th:text="#{setup.title}">Interview Setup</h1>
				<p class="text-slate-400 mt-1 text-sm" th:text="#{setup.subtitle}">Configure your interview session</p>
			</div>

			<!--/*  Progress Steps  */-->
			<th:block th:replace="~{pages/setup/fragments/progress :: progressIndicator(currentStep=${currentStep})}" />

			<!--/*  Form Container  */-->
			<div class="bg-slate-800/80 p-5 rounded-2xl shadow-2xl border border-slate-700 backdrop-blur-md">
				<form th:action="@{/setup/step2}" th:object="${setupForm}" method="post" enctype="multipart/form-data">
					<!--/*  Step Title  */-->
					<div class="text-center mb-3">
						<h2 class="text-xl font-bold text-white mb-1" th:text="#{setup.step2.title}">Interview Details</h2>
						<p class="text-slate-400 text-sm" th:text="#{setup.step2.subtitle}">Choose your target position and settings</p>
					</div>

					<div class="space-y-3">
						<!--/*  Target Position  */-->
						<div>
							<label class="block text-sm font-medium text-slate-300 mb-2">
								<span th:text="#{setup.step2.targetPosition}">Target Position</span>
								<span class="text-red-500">*</span>
							</label>
							<!--/*  Hidden input that holds the selected position value  */-->
							<input type="hidden" id="position-value" name="position" th:value="${setupForm.position}">

							<!--/*  Preset position chips  */-->
							<div class="flex flex-wrap gap-2 mb-2" id="position-chips">
								<button type="button" onclick="selectPosition(this, 'Junior Java Developer')"
										th:classappend="${setupForm.position == 'Junior Java Developer'} ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'bg-slate-900 border-slate-700 text-slate-400 hover:bg-slate-800'"
										class="px-3 py-1.5 rounded-lg border-2 text-sm font-medium transition"
										th:text="#{setup.position.juniorJava}">Junior Java Developer
								</button>
								<button type="button" onclick="selectPosition(this, 'DevOps Engineer')"
										th:classappend="${setupForm.position == 'DevOps Engineer'} ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'bg-slate-900 border-slate-700 text-slate-400 hover:bg-slate-800'"
										class="px-3 py-1.5 rounded-lg border-2 text-sm font-medium transition"
										th:text="#{setup.position.devops}">DevOps Engineer
								</button>
								<button type="button" onclick="selectPosition(this, 'Frontend Developer')"
										th:classappend="${setupForm.position == 'Frontend Developer'} ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'bg-slate-900 border-slate-700 text-slate-400 hover:bg-slate-800'"
										class="px-3 py-1.5 rounded-lg border-2 text-sm font-medium transition"
										th:text="#{setup.position.frontend}">Frontend Developer
								</button>
								<button type="button" onclick="selectPosition(this, 'Full Stack Developer')"
										th:classappend="${setupForm.position == 'Full Stack Developer'} ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'bg-slate-900 border-slate-700 text-slate-400 hover:bg-slate-800'"
										class="px-3 py-1.5 rounded-lg border-2 text-sm font-medium transition"
										th:text="#{setup.position.fullstack}">Full Stack Developer
								</button>
							</div>

							<!--/*  Custom position button  */-->
							<button type="button" onclick="openCustomPositionModal()"
									id="custom-position-btn"
									th:classappend="${setupForm.position != null and setupForm.position != '' and setupForm.position != 'Junior Java Developer' and setupForm.position != 'Frontend Developer' and setupForm.position != 'Full Stack Developer' and setupForm.position != 'DevOps Engineer' and setupForm.position != 'custom'} ? 'border-blue-500 bg-blue-500/10 text-blue-400 shadow-[0_0_12px_rgba(59,130,246,0.5)]' : 'border-dashed border-slate-600 text-slate-400 hover:border-blue-500 hover:text-blue-400 animate-subtle-glow'"
									class="w-full py-2 rounded-lg border-2 text-sm font-medium transition flex items-center justify-center gap-2">
								<i class="fa-solid fa-pencil"></i>
								<span id="custom-position-label"
										th:text="${setupForm.position != null and setupForm.position != '' and setupForm.position != 'Junior Java Developer' and setupForm.position != 'Frontend Developer' and setupForm.position != 'Full Stack Developer' and setupForm.position != 'DevOps Engineer' and setupForm.position != 'custom'} ? ${setupForm.position} : #{setup.step2.customPosition.button}">Can't find your position? Type your own</span>
							</button>

							<p th:if="${#fields.hasErrors('position')}" th:errors="*{position}" class="mt-2 text-sm text-red-400"></p>
						</div>

						<!--/*  Difficulty Level  */-->
						<div>
							<label class="block text-sm font-medium text-slate-300 mb-3">
								<span th:text="#{setup.difficulty.label}">Difficulty Level</span>
								<span class="text-red-500">*</span>
							</label>
							<div class="grid grid-cols-3 gap-3">
								<!--/*  Easy  */-->
								<label class="cursor-pointer group relative">
									<input type="radio" th:field="*{difficulty}" value="Easy" class="peer sr-only">
									<div class="text-center py-3 rounded-xl border-2 border-slate-700 bg-slate-900 text-slate-400 peer-checked:bg-green-500/10 peer-checked:border-green-500 peer-checked:text-green-400 transition hover:bg-slate-800 font-medium">
										<i class="fa-solid fa-mug-hot text-xl mb-2"></i>
										<div th:text="#{setup.difficulty.easy}">Chill</div>
									</div>
									<div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-700 text-xs text-slate-200 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10" th:text="#{setup.difficulty.easy.tooltip}">
										<div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-700"></div>
									</div>
								</label>
								<!--/*  Standard  */-->
								<label class="cursor-pointer group relative">
									<input type="radio" th:field="*{difficulty}" value="Standard" class="peer sr-only">
									<div class="text-center py-3 rounded-xl border-2 border-slate-700 bg-slate-900 text-slate-400 peer-checked:bg-blue-500/10 peer-checked:border-blue-500 peer-checked:text-blue-400 transition hover:bg-slate-800 font-medium">
										<i class="fa-solid fa-briefcase text-xl mb-2"></i>
										<div th:text="#{setup.difficulty.standard}">Standard</div>
									</div>
									<div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-700 text-xs text-slate-200 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10" th:text="#{setup.difficulty.standard.tooltip}">
										<div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-700"></div>
									</div>
								</label>
								<!--/*  Hard  */-->
								<label class="cursor-pointer group relative">
									<input type="radio" th:field="*{difficulty}" value="Hard" class="peer sr-only">
									<div class="text-center py-3 rounded-xl border-2 border-slate-700 bg-slate-900 text-slate-400 peer-checked:bg-red-500/10 peer-checked:border-red-500 peer-checked:text-red-400 transition hover:bg-slate-800 font-medium">
										<i class="fa-solid fa-fire text-xl mb-2"></i>
										<div th:text="#{setup.difficulty.hard}">Stress</div>
									</div>
									<div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-700 text-xs text-slate-200 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10" th:text="#{setup.difficulty.hard.tooltip}">
										<div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-700"></div>
									</div>
								</label>
							</div>
						</div>

						<!--/*  CV Upload  */-->
						<div id="cv-upload-section">
							<label class="block text-sm font-medium text-slate-300 mb-3">
								<span th:text="#{setup.cv.label}">Resume/CV</span>
								<span class="text-slate-500" th:text="#{setup.cv.optional}">(Optional)</span>
							</label>

							<!--/*  Show uploaded file if exists (server-side)  */-->
							<div th:if="${setupForm.cvFileName != null}" id="cv-preview-server" class="mb-3 p-4 bg-slate-900/50 border-2 border-green-500/50 rounded-xl">
								<div class="flex items-center gap-3">
									<i class="fa-solid fa-file-lines text-2xl text-green-400"></i>
									<div class="flex-1">
										<p class="text-green-400 font-medium" th:text="${setupForm.cvFileName}">cv.pdf</p>
										<p class="text-xs text-slate-500" th:text="#{setup.cv.uploaded}">File uploaded</p>
									</div>
									<a th:href="@{/setup/step2(clearCv=true)}" class="text-red-400 hover:text-red-300 text-sm font-medium" th:text="#{setup.cv.remove}">Remove</a>
								</div>
							</div>

							<!--/*  Client-side preview (shown immediately after file selection)  */-->
							<div id="cv-preview-client" class="hidden mb-3 p-4 bg-slate-900/50 border-2 border-blue-500/50 rounded-xl">
								<div class="flex items-center gap-3">
									<i class="fa-solid fa-file-lines text-2xl text-blue-400"></i>
									<div class="flex-1">
										<p id="cv-preview-filename" class="text-blue-400 font-medium">file.pdf</p>
										<p class="text-xs text-slate-500" th:text="#{setup.cv.processing}">Processing...</p>
									</div>
									<div class="animate-spin">
										<i class="fa-solid fa-spinner text-blue-400"></i>
									</div>
								</div>
							</div>

							<!--/*  Upload area (show only if no file uploaded)  */-->
							<div th:if="${setupForm.cvFileName == null}" id="cv-upload-area" class="relative border-2 border-dashed border-slate-700 rounded-xl p-3 text-center hover:border-blue-500 transition cursor-pointer bg-slate-900/50">
								<label for="cv-file-input" class="sr-only">Upload CV File</label>
								<input type="file"
										id="cv-file-input"
										name="cvFile"
										accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
										class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
										onchange="handleCvFileSelect(this)">
								<div>
									<i class="fa-solid fa-cloud-arrow-up text-2xl text-slate-500 mb-1"></i>
									<p class="text-slate-400 font-medium text-sm" th:text="#{setup.cv.dropText}">Drop your CV here or click to browse</p>
									<p class="text-slate-600 text-xs mt-1" th:text="#{setup.cv.fileTypes}">PDF or DOCX, max 10MB</p>
								</div>
							</div>

							<!--/*  Client-side error display (for JS validation)  */-->
							<div id="cv-error-client" class="hidden mt-2 p-3 bg-red-500/10 border border-red-500/50 rounded-lg">
								<p id="cv-error-message" class="text-sm text-red-400 flex items-center gap-2">
									<i class="fa-solid fa-circle-exclamation"></i>
									<span></span>
								</p>
							</div>

							<!--/*  Server-side error display  */-->
							<p th:if="${#fields.hasErrors('cvFile')}" th:errors="*{cvFile}" class="mt-2 text-sm text-red-400 flex items-center gap-1">
								<i class="fa-solid fa-circle-exclamation"></i>
							</p>
						</div>
					</div>

					<!--/*  Navigation Buttons  */-->
					<div class="flex items-center justify-between mt-4 pt-3 border-t border-slate-700">
						<a th:href="@{/setup/step1}"
								class="px-6 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
							<i class="fa-solid fa-arrow-left mr-2"></i>
							<span th:text="#{setup.button.back}">Back</span>
						</a>
						<button type="submit"
								class="px-8 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold transition shadow-lg shadow-blue-500/30">
							<span th:text="#{setup.button.next}">Next</span>
							<i class="fa-solid fa-arrow-right ml-2"></i>
						</button>
					</div>
				</form>
			</div>
		</div>
	</section>

	<!--/*  Custom Position Modal  */-->
	<div id="custom-position-modal" class="fixed inset-0 z-50 hidden">
		<div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeCustomPositionModal()"></div>
		<div class="relative z-10 flex items-center justify-center min-h-screen p-4">
			<div class="bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md p-8">
				<h3 class="text-xl font-bold text-white text-center mb-6" th:text="#{setup.step2.customPosition.modalTitle}">Enter Your Position</h3>
				<input type="text"
						id="custom-position-input"
						th:placeholder="#{setup.step2.customPosition.placeholder}"
						class="w-full bg-slate-900 border-2 border-slate-700 rounded-xl px-5 py-4 text-white text-lg focus:outline-none focus:border-blue-500 transition"
						maxlength="50"
						autocomplete="off">
				<p class="mt-2 text-xs text-slate-500 text-center" th:text="#{setup.step2.customPosition.modalHint}">e.g. "UI/UX Designer", "Data Analyst"</p>
				<div class="flex gap-3 mt-6">
					<button type="button" onclick="closeCustomPositionModal()"
							class="flex-1 px-4 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
						<span th:text="#{setup.step2.customPosition.cancel}">Cancel</span>
					</button>
					<button type="button" onclick="confirmCustomPosition()"
							class="flex-1 px-4 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold transition shadow-lg shadow-blue-500/30">
						<span th:text="#{setup.step2.customPosition.confirm}">Confirm</span>
					</button>
				</div>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		const PRESET_POSITIONS = [
			'Junior Java Developer', 'DevOps Engineer', 'Frontend Developer', 'Full Stack Developer'
		];
		const DEFAULT_CUSTOM_LABEL = /*[[#{setup.step2.customPosition.button}]]*/ "Can't find your position? Type your own";

		function selectPosition(chipEl, value) {
			// Update hidden field
			document.getElementById('position-value').value = value;

			// Reset all chips to unselected
			document.querySelectorAll('#position-chips button').forEach(btn => {
				btn.className = btn.className
					.replace(/bg-blue-500\/20/g, 'bg-slate-900')
					.replace(/border-blue-500/g, 'border-slate-700')
					.replace(/text-blue-400/g, 'text-slate-400');
				if (!btn.classList.contains('hover:bg-slate-800')) {
					btn.classList.add('hover:bg-slate-800');
				}
			});

			// Highlight selected chip
			chipEl.className = chipEl.className
				.replace(/bg-slate-900/g, 'bg-blue-500/20')
				.replace(/border-slate-700/g, 'border-blue-500')
				.replace(/text-slate-400/g, 'text-blue-400');
			chipEl.classList.remove('hover:bg-slate-800');

			// Reset custom button to default state
			const customBtn = document.getElementById('custom-position-btn');
			customBtn.className = customBtn.className
				.replace(/border-blue-500/g, 'border-dashed border-slate-600')
				.replace(/bg-blue-500\/10/g, '')
				.replace(/text-blue-400/g, 'text-slate-400');
			if (!customBtn.classList.contains('hover:border-blue-500')) {
				customBtn.classList.add('hover:border-blue-500', 'hover:text-blue-400');
			}
			document.getElementById('custom-position-label').textContent = DEFAULT_CUSTOM_LABEL;
		}

		function openCustomPositionModal() {
			const modal = document.getElementById('custom-position-modal');
			const input = document.getElementById('custom-position-input');
			modal.classList.remove('hidden');

			// Pre-fill if a custom value was already set
			const currentValue = document.getElementById('position-value').value;
			if (currentValue && !PRESET_POSITIONS.includes(currentValue)) {
				input.value = currentValue;
			} else {
				input.value = '';
			}
			setTimeout(() => input.focus(), 100);

			// Allow Enter key to confirm
			input.onkeydown = function (e) {
				if (e.key === 'Enter') {
					e.preventDefault();
					confirmCustomPosition();
				}
			};
		}

		function closeCustomPositionModal() {
			document.getElementById('custom-position-modal').classList.add('hidden');
		}

		function confirmCustomPosition() {
			const input = document.getElementById('custom-position-input');
			const value = input.value.trim();
			if (!value) return;

			// Set the hidden position field
			document.getElementById('position-value').value = value;

			// Deselect all preset chips
			document.querySelectorAll('#position-chips button').forEach(btn => {
				btn.className = btn.className
					.replace(/bg-blue-500\/20/g, 'bg-slate-900')
					.replace(/border-blue-500/g, 'border-slate-700')
					.replace(/text-blue-400/g, 'text-slate-400');
				if (!btn.classList.contains('hover:bg-slate-800')) {
					btn.classList.add('hover:bg-slate-800');
				}
			});

			// Highlight the custom button and show the value
			const customBtn = document.getElementById('custom-position-btn');
			customBtn.className = customBtn.className
				.replace(/border-dashed/g, '')
				.replace(/border-slate-600/g, 'border-blue-500')
				.replace(/text-slate-400/g, 'text-blue-400');
			customBtn.classList.add('bg-blue-500/10');
			customBtn.classList.remove('hover:border-blue-500', 'hover:text-blue-400');
			document.getElementById('custom-position-label').textContent = value;

			closeCustomPositionModal();
		}

		function showCvError(message) {
			const errorContainer = document.getElementById('cv-error-client');
			const errorMessage = document.getElementById('cv-error-message');
			if (errorContainer && errorMessage) {
				errorMessage.textContent = message;
				errorContainer.classList.remove('hidden');
			}
		}

		function hideCvError() {
			const errorContainer = document.getElementById('cv-error-client');
			if (errorContainer) {
				errorContainer.classList.add('hidden');
			}
		}

		function handleCvFileSelect(input) {
			hideCvError();

			if (input.files && input.files[0]) {
				const file = input.files[0];
				const fileName = file.name;

				// Validate file type
				const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
				const validExtensions = ['.pdf', '.docx'];
				const ext = fileName.toLowerCase().substring(fileName.lastIndexOf('.'));

				if (!validTypes.includes(file.type) && !validExtensions.includes(ext)) {
					showCvError(/*[[#{validation.cv.invalidType}]]*/ 'Please upload a PDF or DOCX file');
					input.value = '';
					return;
				}

				// Validate file size (10MB max)
				if (file.size > 10 * 1024 * 1024) {
					showCvError(/*[[#{validation.cv.tooLarge}]]*/ 'File size must be less than 10MB');
					input.value = '';
					return;
				}

				// Show client-side preview immediately
				const uploadArea = document.getElementById('cv-upload-area');
				const clientPreview = document.getElementById('cv-preview-client');
				const filenameEl = document.getElementById('cv-preview-filename');

				if (uploadArea) uploadArea.classList.add('hidden');
				if (clientPreview) clientPreview.classList.remove('hidden');
				if (filenameEl) filenameEl.textContent = fileName;

				// Auto-submit the form to process the CV on the server
				const form = input.closest('form');
				if (form) {
					setTimeout(() => form.submit(), 100);
				}
			}
		}
	</script>
</div>

</html>
